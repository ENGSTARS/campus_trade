import{k as m,n as r,o as w}from"./index-B1S_F-6_.js";const A="campustrade-local-conversations",v="campustrade-local-messages";function p(t){return`${A}:${t||"guest"}`}function d(t){return`${v}:${t||"guest"}`}function g(t){const e=localStorage.getItem(p(t));if(!e)return[];try{const s=JSON.parse(e);return Array.isArray(s)?s:[]}catch{return[]}}function D(t,e){localStorage.setItem(p(t),JSON.stringify(e))}function l(t){const e=localStorage.getItem(d(t));if(!e)return{};try{const s=JSON.parse(e);return s&&typeof s=="object"?s:{}}catch{return{}}}function O(t,e){localStorage.setItem(d(t),JSON.stringify(e))}function f(t){return[...t].sort((e,s)=>new Date(s.updatedAt).getTime()-new Date(e.updatedAt).getTime())}function I(t){return[...t].sort((e,s)=>new Date(e.createdAt).getTime()-new Date(s.createdAt).getTime())}function u(t,e){const s=new Map;for(const n of t)s.set(n.id,n);for(const n of e)s.set(n.id,{...s.get(n.id),...n});return f(Array.from(s.values()))}function c(t,e){const s=g(t),i=s.some(a=>a.id===e.id)?s.map(a=>a.id===e.id?{...a,...e}:a):[e,...s];D(t,f(i))}const y={async getConversations(t){let e=m;try{const n=await r.get("/messaging/conversations");e=n?.data?.items||n?.items||[]}catch{}const s=g(t);return{items:u(e,s)}},async getMessages(t,e){let s=w[t]||[];try{const a=await r.get(`/messaging/conversations/${t}`);s=a?.data?.items||a?.items||[]}catch{}const i=l(e)[t]||[];return{items:I([...s,...i])}},async sendMessage(t,e,s){const n=new Date().toISOString(),i={id:`m-local-${Date.now()}`,fromMe:e.fromMe??!0,message:e.message,createdAt:n},a=l(s),o=a[t]||[];a[t]=[...o,i],O(s,a);const S=u(m,g(s)).find(C=>C.id===t)||null,M={id:t,participantId:e.participantId||"",name:e.participantName||"Conversation",unread:0,lastMessage:e.message,updatedAt:n};c(s,{...S||M,lastMessage:e.message,updatedAt:n});try{await r.post(`/messaging/conversations/${t}`,e)}catch{}return{success:!0,item:i}},async upsertConversation(t,e){const i=((await this.getConversations(e))?.items||[]).find(o=>o.participantId===t.participantId);if(i){const o={...i,name:t.name||i.name,participantId:t.participantId||i.participantId,listingId:t.listingId||i.listingId};return c(e,o),o}const a={id:`c-local-${Date.now()}`,participantId:t.participantId,name:t.name||"Seller",unread:0,lastMessage:"",updatedAt:new Date().toISOString(),listingId:t.listingId};return c(e,a),a}};export{y as m};
