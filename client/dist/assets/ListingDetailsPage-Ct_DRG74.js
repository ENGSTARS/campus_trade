import{r as h,j as e,f as X,B as f,L as Z,R as ee,u as se,g as te,e as ae,c as ne,d as ie,l as S}from"./index-B1S_F-6_.js";import{m as O}from"./messagingApi-CBHWKQ9-.js";import{g as R}from"./listingPermissions-auyDyiec.js";import{E}from"./ErrorState-1quVR8lb.js";import{S as M}from"./Skeleton-BK5u2klB.js";import{B as L}from"./Badge-C6W-SCl_.js";import{C as re}from"./Card-DAcoRpIw.js";import{S as le,L as oe}from"./ListingCard-DHoE9UHn.js";import{u as A,a as $,o as de,s as ce,n as me,r as ue}from"./validators-BqRfyaxh.js";import{M as B,R as fe}from"./ReviewModal-DlYS5sYH.js";import{I as xe}from"./Input-DYW_1lTB.js";import{S as pe}from"./Select-ysVb1C2v.js";function ge({images:s=[],title:a}){const[d,r]=h.useState(0),m=s[d]||s[0];return e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"card-surface overflow-hidden p-0",children:e.jsx("img",{src:m,alt:a,className:"h-80 w-full object-cover transition duration-500 hover:scale-[1.01] sm:h-[420px]"})}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:s.map((x,n)=>e.jsx("button",{className:`overflow-hidden rounded-xl border transition ${n===d?"border-brand-500 shadow-sm":"border-slate-200 hover:border-brand-300"}`,onClick:()=>r(n),children:e.jsx("img",{src:x,alt:`${a} ${n+1}`,className:"h-20 w-full object-cover"})},x))})]})}function he({listing:s,currentUser:a,onOffer:d,onOrder:r,onReport:m,onReview:x,onEdit:n,onDelete:c,onMarkStatus:p,onMessageSeller:u}){const{isLoggedIn:b,isOwner:g,isAvailable:j,isSecondHand:w,isNew:N,canBuyOrOffer:y}=R(s,a);return e.jsxs(re,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h1",{className:"font-display text-2xl font-bold text-slate-900",children:s.title}),e.jsx("p",{className:"text-2xl font-bold text-brand-700",children:X(s.price)}),e.jsx("p",{className:"text-sm leading-relaxed text-slate-600",children:s.description})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(L,{label:s.condition}),e.jsx(L,{label:s.type}),e.jsx(L,{label:s.status}),g?e.jsx(L,{label:"Your Listing"}):null,e.jsx("span",{className:"text-xs text-slate-500",children:s.category}),e.jsx("span",{className:"text-xs text-slate-500",children:s.campus})]}),e.jsxs("div",{className:"rounded-xl border border-brand-100 bg-brand-50/60 p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-800",children:"Seller"}),e.jsx("p",{className:"text-sm text-slate-700",children:s.seller.name}),e.jsxs("p",{className:"text-xs text-slate-500",children:["Rating ",s.seller.rating," | ",s.seller.transactions," transactions"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 border-t border-slate-100 pt-3",children:[g?e.jsxs(e.Fragment,{children:[e.jsx(f,{variant:"secondary",onClick:n,disabled:!j,children:"Edit Listing"}),e.jsx(f,{variant:"danger",onClick:c,disabled:!j,children:"Delete Listing"}),e.jsx(f,{variant:"secondary",onClick:()=>p("RESERVED"),disabled:!j,children:"Mark Reserved"}),e.jsx(f,{variant:"secondary",onClick:()=>p("SOLD"),disabled:!j,children:"Mark Sold"})]}):b?e.jsxs(e.Fragment,{children:[w?e.jsx(f,{onClick:d,disabled:!y,children:"Make Offer"}):null,N?e.jsx(f,{onClick:r,disabled:!y,children:"Place Order"}):null]}):e.jsx(Z,{to:"/login",className:"btn-primary",children:"Login to Continue"}),!g&&b?e.jsx(f,{variant:"secondary",onClick:u,disabled:g,children:"Message Seller"}):null,!g&&b?e.jsx(le,{listingId:s.id,isWishlisted:s.isWishlisted,disabled:!j}):null,g?null:e.jsx(f,{variant:"ghost",onClick:m,disabled:!b,children:"Report"}),!g&&b?e.jsx(f,{variant:"secondary",onClick:x,children:"Leave Review"}):null,j?null:e.jsx("span",{className:"rounded-lg bg-slate-100 px-3 py-2 text-xs font-semibold text-slate-600",children:"Listing is not available right now."})]})]})}function je({listing:s,currentUser:a,onOffer:d,onOrder:r,onReport:m,onReview:x,onEdit:n,onDelete:c,onMarkStatus:p,onMessageSeller:u}){return e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-[1.2fr_0.8fr]",children:[e.jsx(ge,{images:s.images,title:s.title}),e.jsx(he,{listing:s,currentUser:a,onOffer:d,onOrder:r,onReport:m,onReview:x,onEdit:n,onDelete:c,onMarkStatus:p,onMessageSeller:u})]})}function be({listings:s,currentUser:a,onEditListing:d,onDeleteListing:r}){return s.length?e.jsxs("section",{className:"mt-8 space-y-3",children:[e.jsx("h2",{className:"text-xl font-semibold text-slate-900",children:"Related Listings"}),e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3",children:s.map(m=>e.jsx(oe,{listing:m,currentUser:a,onEdit:d,onDelete:r},m.id))})]}):null}const ve=de({amount:me().min(1,"Enter a valid amount"),note:ce().max(200,"Keep your note under 200 characters").optional()});function ye({isOpen:s,onClose:a,onSubmit:d}){const{register:r,handleSubmit:m,reset:x,formState:{errors:n,isSubmitting:c}}=A({resolver:$(ve),defaultValues:{amount:"",note:""}}),p=async u=>{await d(u),x(),a()};return e.jsx(B,{isOpen:s,onClose:a,title:"Make an Offer",children:e.jsxs("form",{className:"space-y-3",onSubmit:m(p),children:[e.jsx(xe,{label:"Offer amount (USD)",type:"number",...r("amount"),error:n.amount?.message,placeholder:"40"}),e.jsxs("label",{className:"flex flex-col gap-1.5 text-sm text-slate-700",children:[e.jsx("span",{className:"font-medium",children:"Message (optional)"}),e.jsx("textarea",{className:"input-base min-h-24 resize-none",...r("note"),placeholder:"Add a note for the seller"}),n.note?.message?e.jsx("span",{className:"text-xs text-rose-600",children:n.note.message}):null]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-1",children:[e.jsx(f,{variant:"secondary",onClick:a,children:"Cancel"}),e.jsx(f,{type:"submit",disabled:c,children:"Send Offer"})]})]})})}function Se({isOpen:s,onClose:a,onSubmit:d}){const{register:r,handleSubmit:m,reset:x,formState:{errors:n,isSubmitting:c}}=A({resolver:$(ue),defaultValues:{reason:"",details:""}}),p=async u=>{await d(u),x(),a()};return e.jsx(B,{isOpen:s,onClose:a,title:"Report Listing",children:e.jsxs("form",{className:"space-y-3",onSubmit:m(p),children:[e.jsx(pe,{label:"Reason",...r("reason"),options:[{value:"",label:"Select reason"},...ee.map(u=>({value:u,label:u}))],error:n.reason?.message}),e.jsxs("label",{className:"flex flex-col gap-1.5 text-sm text-slate-700",children:[e.jsx("span",{className:"font-medium",children:"Additional details"}),e.jsx("textarea",{className:"input-base min-h-24 resize-none",...r("details"),placeholder:"Optional details to support your report"}),n.details?.message?e.jsx("span",{className:"text-xs text-rose-600",children:n.details.message}):null]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-1",children:[e.jsx(f,{variant:"secondary",onClick:a,children:"Cancel"}),e.jsx(f,{type:"submit",disabled:c,children:"Submit Report"})]})]})})}function Be(){const s=se(),{listingId:a}=te(),{listings:d,deleteListing:r,updateListingStatus:m,createOrderForListing:x}=ae(),{user:n}=ne(),{addToast:c}=ie(),[p,u]=h.useState(null),[b,g]=h.useState([]),[j,w]=h.useState(!0),[N,y]=h.useState(""),[P,I]=h.useState(!1),[T,C]=h.useState(!1),[F,D]=h.useState(!1);h.useEffect(()=>{async function t(){w(!0),y("");try{const[o,v]=await Promise.all([S.getListingById(a),S.getRelatedListings(a)]);u(o?.item||null),g(v?.items||[])}catch{y("Could not load listing details")}finally{w(!1)}}t()},[a]);const l=h.useMemo(()=>d.find(t=>t.id===a)||p,[d,a,p]),i=l?R(l,n):null,k=async t=>{if(!(!l||!n?.id))try{const o=await O.upsertConversation({participantId:l.sellerId,name:l.seller?.name,listingId:l.id},n.id);await O.sendMessage(o.id,{message:t,participantId:l.sellerId,participantName:l.seller?.name},n.id)}catch{}},H=async t=>{if(!i)return;if(!i.isLoggedIn){s("/login");return}if(!i.canBuyOrOffer)return;await S.submitOffer(a,t);const o=t.note?.trim()?`Hi! I sent an offer of $${t.amount}. Note: ${t.note.trim()}`:`Hi! I sent an offer of $${t.amount}.`;await k(o),c({type:"success",message:"Offer sent to seller"})},U=async()=>{if(!i)return;if(!i.isLoggedIn){s("/login");return}!i.canBuyOrOffer||!await x(l,n)||(u(o=>o&&{...o,status:"SOLD"}),g(o=>o.map(v=>v.id===l.id?{...v,status:"SOLD"}:v)),await k(`Hi! I placed an order for "${l.title}".`),c({type:"success",message:"Order placed. You can now message the seller."}))},V=async t=>{!i||!i.isLoggedIn||i.isOwner||(await S.reportListing(a,t),c({type:"info",message:"Listing reported successfully"}))},W=async t=>{!i||!i.isLoggedIn||i.isOwner||(await S.submitReview(a,t),c({type:"success",message:"Review submitted"}))},_=()=>{s(`/listings/${a}/edit`)},z=async()=>{!i?.isOwner||!i.isAvailable||!window.confirm("Delete this listing? This action cannot be undone.")||!await r(a)||(c({type:"success",message:"Listing deleted"}),s("/"))},Y=async t=>{!i?.isOwner||!i.isAvailable||!await m(a,t)||c({type:"success",message:`Listing marked as ${t.toLowerCase()}`})},G=async()=>{if(!i?.canMessageSeller)return;const t=await O.upsertConversation({participantId:l.sellerId,name:l.seller?.name,listingId:l.id},n?.id);s("/messages",{state:{conversationId:t.id}})},K=t=>{t?.id&&s(`/listings/${t.id}/edit`)},q=async t=>{if(!t?.id)return;const o=R(t,n);!o.isOwner||!o.isAvailable||!window.confirm("Delete this listing? This action cannot be undone.")||!await r(t.id)||(g(J=>J.filter(Q=>Q.id!==t.id)),c({type:"success",message:"Listing deleted"}))};return j?e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-[1.2fr_0.8fr]",children:[e.jsx(M,{className:"h-[420px] w-full"}),e.jsx(M,{className:"h-[420px] w-full"})]}):N?e.jsx(E,{title:"Unable to open listing",description:N}):l?e.jsxs("div",{children:[e.jsx(je,{listing:l,currentUser:n,onOffer:()=>I(!0),onOrder:U,onReport:()=>C(!0),onReview:()=>D(!0),onEdit:_,onDelete:z,onMarkStatus:Y,onMessageSeller:G}),e.jsx(be,{listings:b,currentUser:n,onEditListing:K,onDeleteListing:q}),e.jsx(ye,{isOpen:P,onClose:()=>I(!1),onSubmit:H}),e.jsx(Se,{isOpen:T,onClose:()=>C(!1),onSubmit:V}),e.jsx(fe,{isOpen:F,onClose:()=>D(!1),onSubmit:W})]}):e.jsx(E,{title:"Listing not found",description:"This listing may have been removed."})}export{Be as default};
