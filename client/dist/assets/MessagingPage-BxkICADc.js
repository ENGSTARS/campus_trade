import{j as e,h as A,r as o,B as E,i as I,u as D,c as L}from"./index-B1S_F-6_.js";import{m as h}from"./messagingApi-CBHWKQ9-.js";import{E as T}from"./ErrorState-1quVR8lb.js";import{E as $}from"./EmptyState-CYPOGT4r.js";import{S as k}from"./Skeleton-BK5u2klB.js";function B({conversations:d,activeConversationId:c,onSelect:n}){return e.jsxs("aside",{className:"card-surface h-[70vh] overflow-auto p-2",children:[e.jsx("h2",{className:"px-2 py-2 text-sm font-semibold text-slate-900",children:"Conversations"}),e.jsx("div",{className:"space-y-1",children:d.map(t=>e.jsxs("button",{className:`w-full rounded-xl px-3 py-3 text-left transition ${t.id===c?"bg-brand-50":"hover:bg-slate-50"}`,onClick:()=>n(t.id),children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"font-medium text-slate-800",children:t.name}),t.unread>0?e.jsx("span",{className:"inline-flex min-h-5 min-w-5 items-center justify-center rounded-full bg-brand-500 px-1 text-xs font-semibold text-white",children:t.unread}):null]}),e.jsx("p",{className:"mt-1 truncate text-xs text-slate-500",children:t.lastMessage}),e.jsx("p",{className:"mt-1 text-[11px] text-slate-400",children:A(t.updatedAt)})]},t.id))})]})}function U({messages:d,participantName:c,onSend:n}){const[t,m]=o.useState(""),i=s=>{s.preventDefault(),t.trim()&&(n(t.trim()),m(""))};return e.jsxs("section",{className:"card-surface flex h-[70vh] flex-col p-0",children:[e.jsx("header",{className:"border-b border-slate-100 px-4 py-3",children:e.jsx("h2",{className:"font-semibold text-slate-900",children:c||"Select a conversation"})}),e.jsx("div",{className:"flex-1 space-y-2 overflow-auto bg-slate-50 p-4",children:d.map(s=>e.jsx("div",{className:`flex ${s.fromMe?"justify-end":"justify-start"}`,children:e.jsx("p",{className:`max-w-[80%] rounded-2xl px-3 py-2 text-sm ${s.fromMe?"bg-brand-600 text-white":"bg-white text-slate-800"}`,children:s.message})},s.id))}),e.jsxs("form",{onSubmit:i,className:"flex items-center gap-2 border-t border-slate-100 p-3",children:[e.jsx("input",{className:"input-base",value:t,onChange:s=>m(s.target.value),placeholder:"Type your message"}),e.jsx(E,{type:"submit",children:"Send"})]})]})}function z(){const d=I(),c=D(),{user:n}=L(),[t,m]=o.useState([]),[i,s]=o.useState(""),[w,f]=o.useState([]),[S,v]=o.useState(!0),[N,y]=o.useState(""),u=d.state?.conversationId||"";o.useEffect(()=>{let a=!0;async function g(){v(!0),y("");try{const r=((await h.getConversations(n?.id))?.items||[]).filter(p=>p.participantId!==n?.id);if(!a)return;if(m(r),!r.length){s(""),f([]);return}const b=u&&r.some(p=>p.id===u)?u:r[0].id;s(b);const l=await h.getMessages(b,n?.id);if(!a)return;f(l?.items||[]),u&&c("/messages",{replace:!0,state:null})}catch{if(!a)return;y("Unable to load messages right now")}finally{a&&v(!1)}}return g(),()=>{a=!1}},[n?.id,u,c]);const j=o.useMemo(()=>t.find(a=>a.id===i),[t,i]),M=async a=>{s(a);const g=await h.getMessages(a,n?.id);f(g?.items||[])},C=async a=>{if(!i)return;const x=(await h.sendMessage(i,{message:a,participantId:j?.participantId,participantName:j?.name},n?.id))?.item;x&&(f(r=>[...r,x]),m(r=>[...r.map(l=>l.id===i?{...l,lastMessage:x.message,updatedAt:x.createdAt}:l)].sort((l,p)=>new Date(p.updatedAt).getTime()-new Date(l.updatedAt).getTime())))};return S?e.jsx(k,{className:"h-[70vh] w-full"}):N?e.jsx(T,{title:"Messaging unavailable",description:N}):t.length?e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-[340px_1fr]",children:[e.jsx(B,{conversations:t,activeConversationId:i,onSelect:M}),e.jsx(U,{messages:w,participantName:j?.name,onSend:C})]}):e.jsx($,{title:"No conversations yet",description:"Start chatting with a seller from any listing."})}export{z as default};
