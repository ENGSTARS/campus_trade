import{u as R,g as V,c as $,e as H,d as z,r as l,C as w,T as v,b as E,a as C,j as e,B as U,L as W,l as q}from"./index-B1S_F-6_.js";import{u as J,a as K,c as Q}from"./validators-BqRfyaxh.js";import{g as X}from"./listingPermissions-auyDyiec.js";import{C as Z}from"./Card-DAcoRpIw.js";import{I as N}from"./Input-DYW_1lTB.js";import{S as x}from"./Select-ysVb1C2v.js";import{E as S}from"./ErrorState-1quVR8lb.js";import{S as ee}from"./Skeleton-BK5u2klB.js";const L={title:"",description:"",price:"",category:C[0],condition:E[0],type:v[0],campus:w[0],imageUrl:""};function se(a){return{title:a.title||"",description:a.description||"",price:String(a.price??""),category:a.category||C[0],condition:a.condition||E[0],type:a.type||v[0],campus:a.campus||w[0],imageUrl:a.images?.[0]||""}}function de(){const a=R(),{listingId:c}=V(),t=!!c,{user:o}=$(),{createListing:D,updateListing:k,deleteListing:A,listings:O,setListings:T}=H(),{addToast:f}=z(),p=l.useMemo(()=>t&&O.find(s=>s.id===c)||null,[t,O,c]),[i,I]=l.useState(p),[B,u]=l.useState(t),[P,g]=l.useState(""),{register:n,handleSubmit:M,reset:h,formState:{errors:r,isSubmitting:_}}=J({resolver:K(Q),defaultValues:L});l.useEffect(()=>{if(!t){u(!1),g("");return}if(p){I(p),g(""),u(!1);return}let s=!0;async function d(){u(!0),g("");try{const b=await q.getListingById(c);if(!s)return;const m=b?.item||null;I(m),m&&T(j=>j.some(G=>G.id===m.id)?j:[m,...j])}catch{if(!s)return;g("Could not load listing for editing.")}finally{s&&u(!1)}}return d(),()=>{s=!1}},[t,p,c,T]);const y=l.useMemo(()=>t&&i?X(i,o):null,[t,i,o]);l.useEffect(()=>{if(t){if(!i)return;h(se(i));return}h({...L,campus:o?.campus||L.campus})},[t,i,o?.campus,h]);const F=async s=>{if(!o){a("/login");return}if(t){if(!i||!y?.isOwner)return;const b={title:s.title.trim(),description:s.description.trim(),price:Number(s.price),campus:s.campus,category:s.category,condition:s.condition,type:s.type,images:s.imageUrl?[s.imageUrl.trim()]:i.images};if(!await k(i.id,b))return;f({type:"success",message:"Listing updated successfully"}),a(`/listings/${i.id}`);return}const d=await D(s,o);d&&(f({type:"success",message:"Listing posted successfully"}),a(`/listings/${d.id}`))},Y=async()=>{!i||!y?.isOwner||!window.confirm("Delete this listing? This action cannot be undone.")||!await A(i.id)||(f({type:"success",message:"Listing deleted"}),a("/"))};return B?e.jsx(ee,{className:"mx-auto h-[520px] w-full max-w-3xl"}):P?e.jsx(S,{title:"Unable to edit listing",description:P}):t&&!i?e.jsx(S,{title:"Listing not found",description:"This listing may have been removed."}):t&&!y?.isOwner?e.jsx(S,{title:"Editing unavailable",description:"You can only edit listings you posted."}):e.jsx("div",{className:"mx-auto max-w-3xl space-y-4",children:e.jsxs(Z,{className:"p-5 sm:p-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-brand-700",children:t?"Manage Listing":"Sell on CampusTrade"}),e.jsx("h1",{className:"font-display mt-2 text-2xl font-bold text-slate-900 sm:text-3xl",children:t?"Edit Listing":"Post a New Item"}),e.jsx("p",{className:"mt-1 text-sm text-slate-600",children:t?"Update your listing details and keep your post current.":"Your listing will appear on the marketplace immediately and under My Listings in your profile."})]}),e.jsxs("form",{className:"space-y-3",onSubmit:M(F),children:[e.jsx(N,{label:"Title",placeholder:"Ex: iPad 9th Gen - 64GB",...n("title"),error:r.title?.message}),e.jsxs("label",{className:"flex flex-col gap-1.5 text-sm text-slate-700",children:[e.jsx("span",{className:"font-medium",children:"Description"}),e.jsx("textarea",{className:"input-base min-h-28 resize-y",placeholder:"Add condition, what's included, and pickup details.",...n("description")}),r.description?.message?e.jsx("span",{className:"text-xs text-rose-600",children:r.description.message}):null]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsx(N,{label:"Price (USD)",type:"number",min:"1",step:"0.01",placeholder:"100",...n("price"),error:r.price?.message}),e.jsx(x,{label:"Type",...n("type"),options:[{value:"NEW",label:"New"},{value:"SECOND_HAND",label:"Second Hand"}],error:r.type?.message})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsx(x,{label:"Category",...n("category"),options:C.map(s=>({value:s,label:s})),error:r.category?.message}),e.jsx(x,{label:"Condition",...n("condition"),options:E.map(s=>({value:s,label:s})),error:r.condition?.message})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsx(x,{label:"Campus",...n("campus"),options:w.map(s=>({value:s,label:s})),error:r.campus?.message}),e.jsx(N,{label:"Image URL (optional)",placeholder:"https://images.unsplash.com/...",...n("imageUrl"),error:r.imageUrl?.message})]}),e.jsxs("div",{className:"flex flex-wrap justify-between gap-2 pt-2",children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:t?e.jsx(U,{variant:"danger",onClick:Y,children:"Delete Listing"}):null}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(W,{to:t&&i?`/listings/${i.id}`:"/profile",className:"btn-secondary",children:"Cancel"}),e.jsx(U,{type:"submit",disabled:_,children:t?"Save Changes":"Post Item"})]})]})]})]})})}export{de as default};
